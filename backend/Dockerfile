# =============================================================================
# DOCKERFILE ДЛЯ BACKEND (FastAPI + Python)
# =============================================================================
# Этот файл описывает как собрать Docker-образ для бекенда.
# Docker использует этот файл чтобы создать изолированный контейнер
# с нашим приложением и всеми зависимостями.
# =============================================================================

# Базовый образ Python 3.10 (slim = минимальный размер)
FROM python:3.10-slim

# Рабочая директория внутри контейнера
# Все команды будут выполняться из /app
WORKDIR /app

# =============================================================================
# УСТАНОВКА СИСТЕМНЫХ ЗАВИСИМОСТЕЙ
# =============================================================================
# gcc - компилятор C (нужен для некоторых Python-пакетов)
# libpq-dev - библиотека для работы с PostgreSQL
# rm -rf /var/lib/apt/lists/* - очистка кэша apt для уменьшения размера образа
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# =============================================================================
# УСТАНОВКА PYTHON ЗАВИСИМОСТЕЙ
# =============================================================================
# Копируем requirements.txt отдельно для кэширования Docker-слоёв
# Если requirements.txt не изменился, Docker использует кэш
COPY requirements.txt .

# Установка всех Python-пакетов из requirements.txt
# --no-cache-dir = не сохранять кэш pip (экономия места)
RUN pip install --no-cache-dir -r requirements.txt

# =============================================================================
# КОПИРОВАНИЕ КОДА ПРИЛОЖЕНИЯ
# =============================================================================
# Копируем весь код бекенда в контейнер
COPY . .

# =============================================================================
# НАСТРОЙКА СЕТИ
# =============================================================================
# Открываем порт 8000 для входящих подключений
# Это порт на котором будет работать наш API
EXPOSE 8000

# =============================================================================
# ЗАПУСК ПРИЛОЖЕНИЯ
# =============================================================================
# CMD - команда которая выполняется при старте контейнера
# uvicorn - ASGI сервер для FastAPI
# main:app - файл main.py, объект app
# --host 0.0.0.0 - слушать все интерфейсы (важно для Docker)
# --port 8000 - порт сервера
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
