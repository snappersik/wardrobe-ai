// =============================================================================
// AXIOS - НАСТРОЙКА HTTP КЛИЕНТА ДЛЯ API ЗАПРОСОВ
// =============================================================================
// Этот модуль настраивает axios для взаимодействия с бекендом.
// Включает базовый URL, обработку cookies и перехват ошибок.
// =============================================================================

// Axios - популярная библиотека для HTTP запросов
import axios from 'axios'

// =============================================================================
// СОЗДАНИЕ ЭКЗЕМПЛЯРА AXIOS С НАСТРОЙКАМИ
// =============================================================================
const api = axios.create({
    // Базовый URL для всех запросов (бекенд на порту 8000)
    baseURL: 'http://localhost:8000/api',

    // ВАЖНО: withCredentials позволяет отправлять cookies с запросами
    // Необходимо для JWT аутентификации через httpOnly cookies
    withCredentials: true,

    // Заголовки по умолчанию для всех запросов
    headers: {
        'Content-Type': 'application/json',
    }
})

// =============================================================================
// ИНТЕРСЕПТОР ОТВЕТОВ (Response Interceptor)
// =============================================================================
// Интерсептор перехватывает ВСЕ ответы от сервера.
// Используется для централизованной обработки ошибок и редиректов.
api.interceptors.response.use(
    // Успешные ответы (2xx) - просто пропускаем
    (response) => {
        return response
    },

    // Обработка ошибок (4xx, 5xx)
    (error) => {
        const { response } = error

        if (response) {
            // Сервер ответил с ошибкой
            switch (response.status) {
                // ==========================================================
                // 401 Unauthorized - Пользователь не авторизован
                // ==========================================================
                case 401:
                    // Специальная обработка для проверки авторизации (/users/me)
                    // Не редиректим, AuthContext сам обработает эту ошибку
                    if (error.config.url.includes('/users/me')) {
                        return Promise.reject(error)
                    }

                    // Редирект на страницу входа, если мы не на публичных страницах
                    if (!window.location.pathname.includes('/login') &&
                        !window.location.pathname.includes('/register') &&
                        window.location.pathname !== '/') {
                        window.location.href = '/login'
                    }
                    break

                // ==========================================================
                // 403 Forbidden - Доступ запрещён (нет прав)
                // ==========================================================
                case 403:
                    // Редирект на страницу ошибки 403
                    window.location.href = '/403'
                    break

                // ==========================================================
                // 429 Too Many Requests - Превышен лимит запросов
                // ==========================================================
                case 429:
                    // Редирект на страницу ошибки 429 (rate limiting)
                    window.location.href = '/429'
                    break

                // ==========================================================
                // 500 Internal Server Error - Ошибка сервера
                // ==========================================================
                case 500:
                    // Редирект на страницу ошибки 500
                    window.location.href = '/500'
                    break

                // ==========================================================
                // Другие ошибки - просто логируем
                // ==========================================================
                default:
                    console.error('API Error:', error)
            }
        } else {
            // Сервер не ответил (Network Error)
            // Возможные причины: сервер не запущен, нет интернета, CORS
            console.error('Network Error:', error)
        }

        // Пробрасываем ошибку дальше для обработки в компонентах
        return Promise.reject(error)
    }
)

// Экспортируем настроенный экземпляр axios
export default api
